<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Aerohive Children Day</title>

	<style type="text/css">
		*{margin : 0; padding: 0;}
		ul{list-style:none}
		img{border:none}
		body{font: 12px/1.5 arial; background-color:#07a1b1;}

		body.black{background-color : #1d1f20}

		.clearfix:after {
  			display: block;
  			content: '';
  			clear: both;
  			font-size: 0;
  			line-height: 0;
  			visibility: hidden;
		}

		.header{padding-bottom:30px}
		.header h3{font-size : 45px; color : #fff; text-align:center}

		.section-inner{position:relative;width : 1150px; height:798px; margin : 0 auto;}
		.section-outer{position:relative;background:url(src/img/bg_cloud.png) no-repeat center center;}
		.section-head{text-align:center; 1background:url(src/img/img_baby.png) no-repeat center 0;}
		.section-head img{width : 290px; height : 250px; background:url(src/img/frame_baby.png) no-repeat 0 0}
		.section-con{}
		.section-con img{width:140px; height:140px; background:url(src/img/loading1.gif) no-repeat 0 0; border:8px solid rgba(255,255,255,0.6); border-radius:8px; cursor:pointer}
		.section-con img:hover,
		.section-con img.active{border-color:#fff}
		.section-img-wrap{display:inline-block; position:relative;overflow:hidden}
		
		.section-img-wrap span{
			position:absolute; width:140px; height:30px;bottom: 8px; left: 8px;
		   	background-color: #000; opacity: 0.6; line-height:30px; color : #fff;

			-webkit-transition : transform 200ms ease-out;
			-moz-transition : transform 200ms ease-out;
			-ms-transition : transform 200ms ease-out;
			transition : transform 300ms ease-out;

			-webkit-transform : translateY(38px);
			-moz-transform : translateY(38px);
			-ms-transform : translateY(38px);
			transform : translateY(38px);
		}
		.section-img-wrap:hover span{
			-webkit-transform : translateY(-5px);
			-moz-transform : translateY(-5px);
			-ms-transform : translateY(-5px);
			transform : translateY(-5px);
		}

		.section-1{background:url(src/img/cloud_02.png) repeat-x 0 bottom;}
		.section-2{background:#fa8573 url(src/img/cloud_04.png) repeat-x 0 bottom;}
		.section-3{background:#03d7a2 url(src/img/cloud_06.png) repeat-x 0 bottom;}
		.section-4{background-color:#f8b258; padding-bottom:30px}

		.section-list{ margin-top : 30px}
		.section-list li{float:left; text-align:center; position:relative}
		.section-list li::after{position:absolute; top: 90px; left:43%; display:none; content : url(src/img/chosen.png);}
		.section-list li.active::after{display:block}
		.section-list0 li{width : 50%}
		.section-list1 li{width : 33.3%}
		.section-list2 li{width : 25%}
		.section-list3 li{width : 20%}

		.section-num{position:absolute; top : 0; left : 0; font-size:30px; color : #fff;}

		.btn-area{position:absolute; width:100%; bottom:20px; text-align:center}
		.section-btn{
			padding:15px 45px; 
			background-color:#fa8573; -webkit-border-radius : 5px; -moz-border-radius:5px; border-radius:5px; 
			color : #fff; font-weight : 700; border:none; cursor:pointer; font-size : 16px; outline:none; letter-spacing : 2px
		}
		.section-prev-btn{display:none; background-color:#ccc}

		.mask{display:none; position:absolute; top : 0; bottom : 0; left:0; right:0; background:#000; opacity: 0.5;}
		.result-area{display:none;position:fixed; top:50%; left : 50%; margin-left:-317px; margin-top:-200px; width : 635px; height : 400px; background:url(src/img/alarm_img.png) no-repeat 0 0;}
		.result-title{text-align: center;font-size: 25px;color: yellow;padding-top: 20px;}
		.result-btn-area{text-align:center; padding-top:220px;}

		#wrapper{position:relative}
		#btn{margin-left : 30px;}
		.wrapper-inner{background:url(src/img/bg_light.png) no-repeat 0 0;}


		.stage-txt{
			width: 720px;
  			margin: 0 auto;
  			color: #fff;
  			padding-top: 160px;
  			font-size: 50px;
  			text-shadow: 0px 0px 10px #fff;
  			font-style: italic;
		}

		.stage-con{
			letter-spacing: 10px;
  			word-spacing: 10px;
		}

		#stage2-title{
			  letter-spacing: 5px;
			  font-size : 60px
		}

		#stage2-con{
			text-indent: 80px;
  			letter-spacing: 10px;
  			word-spacing: 10px;
		}

		.stage2-btm{
			padding: 60px 100px 0 80px;
		}

		#stage2-yes,
		#stage2-no{
			float:right;
			cursor : pointer;
			-webkit-transition: text-shadow 0.2s ease;
			-moz-transition: text-shadow 0.2s ease;
			-ms-transition: text-shadow 0.2s ease;
			transition: text-shadow 0.2s ease;
		}
		#stage2-no{margin-left : 30px;}
		
		#stage2-yes:hover,
		#stage2-no:hover{
			text-shadow : 0px 0px 10px yellow;
		}


		#page{position:absolute; width:100%; top:0; left : 0; right:0;bottom:0; background-color:#1d1f20;}
		.page-tran{-webkit-transition : transform 2s ease-in-out; -moz-transition : transform 2s ease-in-out;-ms-transition : transform 2s ease-in-out;transition : transform 2s ease-in-out;}
		.page-circle{position:absolute; width:100px; height:100px;bottom:-20px; left : 50%; margin-left:-50px; background:url(src/img/cir.png) no-repeat 0 0 }
		.page-bee{position:absolute;width:110px; height:110px; bottom:-120px; left : 50%; margin-left:-52px; background:url(src/img/bee.gif) no-repeat 0 0 }
		.page-left,
		.page-right{
			position:absolute;
			width : 600px;
			height : 90px;
			bottom:0;
		}
		.page-left{
			left:0;
			background:url(src/img/pl.png) no-repeat 0 0;
		}

		.page-right{
			right : 0;
			background:url(src/img/pr.png) no-repeat 0 0;
		}

		.heart{width:160px;height:200px;position:relative;display:none}
		.heart:before{
			content:" ";
			border-radius:100px 100px 0 0;
			width:80px; height:120px;
			background:#ff0000;
			-moz-transform: rotate(-45deg);
			-ms-transform: rotate(-45deg);
			-webkit-transform: rotate(-45deg);
			position:absolute;
			left:20px;
			-webkit-animation: heart1 2s infinite ease-out;
		}
		.heart:after{
			content:" ";
			width:80px; height:120px;
			background:#ff0000;
			border-radius:100px 100px 0 0;
			-moz-transform: rotate(45deg);
			-ms-transform: rotate(45deg);
			-webkit-transform: rotate(45deg); 
			position:absolute;
			left:48px;top:0px;
			-webkit-animation: heart1 1s infinite ease-out;
			-moz-animation: heart1 1s infinite ease-out;
			-ms-animation: heart1 1s infinite ease-out;
			-animation: heart1 1s infinite ease-out;
		}


		#ceb-egg{display:none; width:250px; height:300px; position:absolute; 
			bottom:30px; left:50%; margin-left:-125px; background:url(src/img/golden_egg.png) no-repeat 0 0; cursor:pointer}

		.side-bee{
			position:fixed;
			width : 135px;
			height : 160px;
			background:url(src/img/bee_side.png) no-repeat 0 0;
			top : 300px;
			right : -70px;
			cursor : pointer;

			-webkit-transition: right 0.2s ease;
			-moz-transition: right 0.2s ease;
			-ms-transition: right 0.2s ease;
			transition: right 0.2s ease;
		}
		.side-bee:hover{
			right : -10px
		}

		#big-img-area{
			position:fixed;
			display : none;
			width : 400px;
			height : 400px;
			border:8px solid #fff;
			border-radius : 5px;
			top:50%;
			left : 50%;
			margin-top : -200px;
			margin-left:-200px;
		}
		#big-img{
			width : 400px;
			height : 400px;
			background:url(src/img/loading1.gif) no-repeat center center 
		}
		#img-close{
			position: absolute;
  width: 30px;
  height: 30px;
  border: 5px solid #fff;
  background: #000;
  color: #fff;
  text-align: center;
  line-height: 30px;
  border-radius: 20px;
  right: -20px;
  top: -20px;
  cursor:pointer
		}

		/**
		  *@Animate for plus level
		  */
		.animate1{
			-webkit-animation : transform1 0.5s ease 0s alternate none;
			-moz-animation : transform1 0.5s ease 0s alternate none;
			-ms-animation : transform1 0.5s ease 0s alternate none;
			animation : transform1 0.5s ease 0s alternate none;
		}

		.animate2{
			-webkit-animation : transform2 0.5s ease 0s alternate none;
			-moz-animation : transform2 0.5s ease 0s alternate none;
			-ms-animation : transform2 0.5s ease 0s alternate none;
			animation : transform2 0.5s ease 0s alternate none;
		}

		@-webkit-keyframes transform1 {
			0% {
				-webkit-transform:perspective(400px) rotateY(0deg);
			}
			100% {
				-webkit-transform:perspective(400px) translateZ(350px) rotateY(180deg);
				opacity: 0;
			}
		}

		@-moz-keyframes transform1 {
			0% {
				-moz-transform:perspective(400px) rotateY(0deg);
			}
			100% {
				-moz-transform:perspective(400px) translateZ(350px) rotateY(180deg);
				opacity: 0;
			}
		}

		@-ms-keyframes transform1 {
			0% {
				-ms-transform:perspective(400px) rotateY(0deg);
			}
			100% {
				-ms-transform:perspective(400px) translateZ(350px) rotateY(180deg);
				opacity: 0;
			}
		}



		@-webkit-keyframes transform2 {
			0% {
				-webkit-transform: rotate(0deg) scale(1);
			}
			100% {
				-webkit-transform: rotate(720deg) scale(8);
				opacity: 0;
			}
		}

		@-moz-keyframes transform2 {
			0% {
				-moz-transform:rotate(0deg) scale(1);
			}
			100% {
				-moz-transform:rotate(720deg) scale(8);
				opacity: 0;
			}
		}

		@-ms-keyframes transform2 {
			0% {
				-ms-transform:rotate(0deg) scale(1);
			}
			100% {
				-ms-transform:rotate(720deg) scale(8);
				opacity: 0;
			}
		}


		@-webkit-keyframes heart1{
			0%{
				box-shadow : 0 0 20px #ff0000;
			}
			10%{box-shadow : 0 0 8px #ff0000;}
			40%{box-shadow : 0 0 15px #ff0000;}
			100%{
				box-shadow : 0 0 25px #ff0000;
			}
		}

		@-moz-keyframes heart1{
			0%{
				box-shadow : 0 0 20px #ff0000;
			}
			10%{box-shadow : 0 0 8px #ff0000;}
			40%{box-shadow : 0 0 15px #ff0000;}
			100%{
				box-shadow : 0 0 25px #ff0000;
			}
		}

		@-ms-keyframes heart1{
			0%{
				box-shadow : 0 0 20px #ff0000;
			}
			10%{box-shadow : 0 0 8px #ff0000;}
			40%{box-shadow : 0 0 15px #ff0000;}
			100%{
				box-shadow : 0 0 25px #ff0000;
			}
		}

	</style>
</head>
<body>

	<div id="wrapper">
		<div class="wrapper-inner">
			
		<div id="header" class="header">
			<h3>Level <span id="level">1</span></h3>
		</div>

		<div class="section section-1">
			<div class="section-outer">
			<div class="section-inner">
			
			</div>
			</div>
		</div>

		<div class="section section-2">
			<div class="section-outer">
			<div class="section-inner">
			
			</div>
			</div>
		</div>

		<div class="section section-3">
			<div class="section-outer">
			<div class="section-inner">
			
			</div>
			</div>
		</div>

		<div class="section section-4">
			<div class="section-outer">
				<div class="section-inner">
				
				</div>

				<p class="btn-area">
					<button id="prevbtn" class="section-btn section-prev-btn">Prev</button>
					<button id="btn" class="section-btn">Next</button>
				</p>
			</div>
		</div>

		</div>


		<div id="mask" class="mask"></div>
		<div id="result" class="result-area">
			<h4 class="result-title">恭喜您，累积得分 <span id="result-score"></span></h4>
			<p class="result-btn-area"><button id="confirm-btn" class="section-btn">OK</button></p>
			<div id="ceb-egg" class="egg"></div>
		</div>
		<div class="side-bee"></div>
		<div id="big-img-area"><img id="big-img" src="" /><span id="img-close">X</span></div>

	</div>

	<script src="src/js/jquery.js"></script>

	<script type="text/javascript">
		(function(){
			var n = 165, m = 56, isDebug, isDay,
				topics = 16, checks = 4, per = topics/checks;

			var names = ['余俊','俞阳东','华鸣飞','曹宇华','何杭军','蒙庚祥','叶琛','林国艳','吴功伟','陈葛','郑永','冯晓嵘','李丹','梁文平','戴丽君','王学成','梁贤','徐昕','宋伟','杜祖海','葛湘英','蔡移华','叶有元','黄舟','冯赟','张利岗','曹文起','罗召明','陈微','程欢','李坤','陈崇来','徐磊','邵桦','何菊霞','米娜','陈友明','蔡文娟','李桢达','曾子胜','潘文简','莫一楠','王蒴','冯大鑫','徐佳见','汪维宇','蒋敏璐','李娟','何福林','胡春涛','俞金妹','陈仕员','房立国','韩群燕','袁正兴','董洪波','戚一品','周昕伟','林海','张磊','常春明','赵宣','王书辉','刘峰雷','陶京','赵宪鹏','王雷雷','郭浩','何伟','李晨雨','林文峰','范鹏','张亮福','陈阳','金敏飞','肖兰宝','赵国军','张杰','陈建梁','林云志','陈财荣','何伟','周少华','盛廉君','饶成','王铁松','岳黎明','叶方','余军','钟晨杰','盛鑫','朱铁柱','梁翠萍','唐丽芳','吴婉婉','李萍','朱钰祥','诸国庆','陈筱丹','郭复强','丘添英','汪宝俊','郑达理','周旭锋','鲁文俊','陈克见','章文洁','王海荣','潘燕非','譚敦敏','曾光华','曹振业','徐杨清','任红阵','何双','钟宇静','魏小兰','潘轶','万真龙','万鹏','方辉','余星','武丽甜','张健','潘力','成晓雄','周佳盛','王晓明','方巧英','许庆光','王田','吴文','胡辉辉','闻尚权','洪徐伟','朱康伟','宗叶君','周煜','金玮','孙云凤','龚利丰','郭笋','金陈杰','孙刚','韦耐','王丽芳','刘云云','王统','吴耀','赵世楠','冀亮','王志强','李典茂','郑扬','刘淳猛','何金骏','郭大龙','方瑞','马俊','楼超权','余伟表','杜娟','李鹏','陈哲','杨军伟'];

			/******************************************/
			//-----------------------------------------
			var encodeStr = "\170\155\144\55\171\161\171\55\150\167\55\152\143\146\55\172\161\143\55\172\170\172\55\153\150\55\171\156\150\55\171\161\142\55\162\170\147\55\153\150\167\55\163\171\143\55\150\172\146\55\155\164\167\55\146\155\55\171\160\55\161\154\172\55\172\150\154\55\164\154\143\55\145\150\143\55\171\172\143\55\171\171\172\55\171\171\163\55\170\167\55\143\163\143\55\142\142\154\55\155\171\143\55\171\143\171\55\171\143\154\55\162\171\143\55\171\143\172\55\172\172\146\55\172\167\147\55\171\170\171\55\142\156\143\55\162\150\147\55\172\161\144\55\153\162\163\55\171\170\170\55\153\170\154\55\161\161\167\55\154\150\143\55\152\171\154\55\164\143\147\55\144\144\147\55\155\161\143\55\172\171\143\55\152\170\167\55\171\156\154\55\172\154\171\55\163\164\155\55\171\162\150\55\170\171\143\55\162\150\55\171\172\171\55\152\150\171";

			(function(){
			 	var dd = new Date(),
					d = dd.getDate(),
					m = dd.getMonth(),
					days = [1,2,3],
					lh = location.hash,
					hash = lh && lh.split('#')[1],
					arr = lh && hash.split('='),
					isEgg = arr && arr[1] === 'egg';

				isDebug = arr && arr[0] === 'debug';
				isDay = ((isDebug && isEgg) || (days.indexOf(d)!==-1 && m === 5));

			})();


			var base = {
				$el : $('#wrapper'),
				
				$ : function(selector){
					return this.$el.find(selector);
				},

				body : $('body'),

				doc : $(document),

				_initialize : function(){
					if(this.els){
						this._attachEls();
					}

					if(this.events){
						this._bindEvents();
					}
				},

				_attachEls : function(){
					var i, dd;
					
				 	for(i in this.els){
						dd = this.els[i];			 
						this[i] = $(dd);
					}			 
				},

				_bindEvents : function(){
					var i, dd, dt, reg = /^(\S+)\s*(.*)$/, match;			  

					for(i in this.events){
						dt = this.events[i];
						dd = 'function' === typeof dt ? dt : this[dt];
						match = i.match(reg);
						this.$el.on(match[1], match[2], $.proxy(dd, this));
					}
				},

				_defer : function(fn, time){
					return setTimeout($.proxy(fn, this), time || 0);		 
				},

				typeTxt : function(){
					var i, dd, dt, n = 0;

		  			for(i in this.txtMap){
						dd = this.txtMap[i];	
						dt = this.$(i);

						(function(el, context){
							$.each(dd.split(''), function(j, a){
								context._defer(function(){el.innerHTML += a;}, 180 * n );	
								n++;
							}); 
						})(dt[0], this);
						
					}
		  		}
				
			};



			var stage1 = $.extend({
				
				template : '<div id="page">'+
							'<div class="page-left"></div>'+
							'<div class="page-right"></div>'+
							'<span class="page-circle"></span>'+
							'<span class="page-bee"></span>'+
						'</div>',

				init : function(){
					this._initialize();

					this.$el.append(this.tmpl = $(this.template));

					this._rendUI();

					return this;
				},

				_rendUI : function(){
					var h = this.doc.height(),
						thro = 100,
						y;

					h += thro;
					y = 'translateY(-'+h+'px)';
					d =  'translateY(0px)';

					this.$('#page').css({'-webkit-transform': y, '-moz-transform' : y, '-ms-transform':y, 'transform':y, 'height' : h+'px'});

					this._defer(function(){
						this.$('#page').css({'-webkit-transform':d,'-moz-transform' : d, '-ms-transform':d, 'transform':d }).addClass('page-tran');
					}, 500);
				},

				destroy : function(){
					this.tmpl.remove();		  
				},

				addStage : function(stage){
					this._defer(function(){
						this.body.addClass('black');
						this.destroy();
						
						stage.init();		
					}, 3500);	   
				},

			}, base);


			var stage2 = $.extend({

				txtMap : {
					'#stage2-title' : 'Dear,',
					'#stage2-con' : 'Do you love it ?',
					'#stage2-yes' : 'Yes',
					'#stage2-no' : 'No'
				},
				events : {
					'click #stage2-no' : '_handleNo',
					'click #stage2-yes' : '_handleYes'
				},
				
				init : function(){
					this._initialize();

					this.$el.append(this.tmpl = $(this.template));

					this._defer(this.typeTxt, 600);
					
				},

			  	template : '<div id="stage2" class="stage-txt">'+
							'<p id="stage2-title"></p>'+
							'<p id="stage2-con"></p>'+
							'<p class="stage2-btm"><span id="stage2-no"></span><span id="stage2-yes"></span></p>'+
						'</div>',

				destroy : function(){
					this.$el.off('#stage2-no,#stage2-yes');
					
		  			this.tmpl.remove();
		  		},

				_handleNo : function(){
					this.destroy();
					stage4.init();

					this.remote(0);
				},

				_handleYes : function(){
					this.destroy();
			 		stage3.init();

					this.remote(1)
			 	},

				remote : function(f){
					if(!isDebug){
						$.post('child/like',{like : f});		 
					 }
				}

			}, base);


			var stage3 = $.extend({

				txtMap : {
					'#stage3-title' : 'I Love You, too !'
				},

				template : '<div class="stage-txt">'+
							'<p class="heart" id="stage3-heart"></p>'+
							'<p id="stage3-title" class="stage-con"></p>'+
						'</div>',

				init : function(){
					this._initialize();

					this.$el.append(this.tmpl = $(this.template));

					this.$('#stage3-heart').show('slow');

					this._defer(this.typeTxt, 1e3);
				}
						
			}, base);


			
			var stage4 = $.extend({

				txtMap : {
					'#stage4-title' : 'You truly broke my heart.',
					'#stage4-con' : 'But, I forgive you this time.'
				},

				template : '<div class="stage-txt" style="width:1000px">'+
							'<p id="stage4-title" class="stage-con"></p>'+
							'<p id="stage4-con" class="stage-con" style="margin-top:20px"></p>'+
						'</div>',

				init : function(){
					this._initialize();

					this.$el.append(this.tmpl = $(this.template));

					this._defer(this.typeTxt, 600);
				}
						
			}, base);



			var maskObj = $.extend({

				els : {
					'maskEl' : '#mask'
				},

				init : function(){
					this._initialize();

					return this;
				},
						
				show : function(){
					this.maskEl.fadeTo(200, 0.6);			 

					return this;
				},

				hide : function(){
					var that = this;
					
					this.maskEl.fadeTo(200, 0, function(){that.maskEl.hide()});

					return this;
				},

				destroy : function(){
					this.maskEl.remove();
				}

			}, base).init();


			var imgObj = $.extend({}, base, {
						
				$el : $('#big-img-area'),

				els : {
					'imgEl' : '#big-img'
				},

				events : {
					'click #img-close' : 'hide'
				},

				init : function(){
					this._initialize();

					return this;
				},

				show : function(url){
					if(url){
						this.imgEl.attr('src', url);
					}

					maskObj.show();
					this.$el.show();
				},

				hide : function(){
					this.$el.hide();
					maskObj.hide();
				}

			}).init();



			return $.extend({

				step : 0,

				n : 1,

				_ret : [],

				_result : [],

				_cache : [],


				els : {
					'sectionInners' : '.section-inner',
					'sections' : '.section',
					'headEl' : '#header',
					'levelEl' : '#level',
					'btnEl' : '#btn',
					'prevEl' : '#prevbtn',
					'wrapper' : '#wrapper',
					'resultEl' : '#result',
					'scoreEl' : '#result-score',
					'resultTitle' : '.result-title'
				},

				events : {
					'click #btn' : '_handleClickBtn',
					'click .section-list img' : '_handleImgClick',
					'click #prevbtn' : '_handleClickPrev',
					'click #confirm-btn' : '_handleClickOk',
					'click #ceb-egg' : '_handleShowBegin',
					'click .section-head a' : '_handlePopupBigImg'
				},

				_startTime : +new Date(),

				
				/**
				  *@Flow
				  */

				init : function(){
					this._prepare();		

					this._initialize();

					this._rendUI();

					//this._checkNeedEgg();
				},

				_prepare : function(){
					var dd, dt, arr, that = this;

					this.employee = this._makeArr(n);
					this.children = this._makeArr(m);

					//console.log(this._makeArr(n), this.children);

					this.usedChildren = this._makeRandomArr(this.children, topics);

					arr = this.usedChildren.slice(0);


					/************************************************/
					//-----------------------------------------------
					// remove employee about child number
					$.each(arr, function(n, item){
						that.employee.splice(that.employee.indexOf(item), 1);		
					});


					//console.log(arr);

					for(var i = 0; i < checks; i++){
						dd = this._ret[i] = [];
						for(var j = 0; j < per; j++){
							dt = dd[j] = [];
							dt.push(arr[0]);
							//console.log(dt);
							dd[j] = dt.concat(this._makeMatchEmployee(arr[0],i));
							//console.log(dd[j]);
							arr.splice(0,1);
						}
					}

					//console.log(this._ret);
					//this._preloadImg(this._ret);

				},

				_rendUI : function(){
					this.setStep(this.step);	  
					
					this.levelEl.text(this.step + 1);
				},

				

				goNext : function(){
					var dd;

					this._cache[this.step] = this._getCacheHtml();

					this.step++;		 

					this.levelEl.text(this.step + 1);

					if(dd = this._cache[this.step]){
						this._rendCache(this.step);
					}else{
						this.setStep(this.step);
					}

					if(this.step > 0){
						this.prevEl.show();
					}

					if(this.step === 3){
						this.btnEl.text('Submit');
					}
				},

				goPrev : function(){
					this._cache[this.step] = this._getCacheHtml();

					this.step--;

					this.levelEl.text(this.step + 1);
			 		
					this._rendCache(this.step);

					if(this.step === 0){
						this.prevEl.hide();
					}

					if(this.step < 3){
						this.btnEl.text('Next');
					}
			 	},

				setStep : function(step){
					var arr = this._ret[step];		  

					this._makeSubjects(arr, step);
				},



				/**
				  *@Events
				  */

				_handleClickBtn : function(e){
					var score;

					if(this.step >= 3){
						if(!this._validate()) return;

						this._toggleRes(1);
						this.scoreEl.text(score = this._getScore());

						// @TODO
						if(!isDebug){
						$.post('child/gamestat',{
							time : +new Date() - this._startTime,
							result : this._result.join(';'),
							score : score		
						});				  
						}
					}else{
						this._scrollTop();

						this.goNext();
					}			  
				},

				_handleImgClick : function(e){
					var t = e.target,
						$t = $(t), cur = 'active',
				  		i = +t.getAttribute('data-topic') - 1,
						ans = t.getAttribute('data-ans'),
						con = $t.closest('.section-con');	

					this._result[i] = ans + '-' + this.usedChildren[i];

					$('.'+cur, con[0]).removeClass(cur);
					//$t.addClass(cur);
					$(t).parents('li').addClass(cur);

					console.log(this._result);
			  	},

				_handleClickOk : function(){
				 	if(isDay){
						this.$('#confirm-btn').hide();			 
						this.resultTitle.hide();
						this.$('#ceb-egg').show();
					}else{
						this._toggleRes(0);
						this.$('.btn-area').hide();
					}				 

				},

				_handlePopupBigImg : function(e){
					e.preventDefault();	 

					imgObj.show(e.currentTarget.getAttribute('ref'));
				},

				_handleClickPrev : function(e){
					this._scrollTop();
				  	this.goPrev();
				},

				_handleShowBegin : function(){
					this._toggleRes(0);   
					
					this._startShow();
				},


				/**
				  *@Help fns
				  */

				_makeSubjects : function(arr, step){
					var ret = [], that = this,
						paPath = 'src/img/people/parent/',
						childPath = 'src/img/people/child_fake/',
						childBigPath = 'src/img/people/child_big_fake/',
						maps = encodeStr.split('-');

					$.each(arr, function(j,items){
											
					var str = '', head = items.shift(), len = items.length,
						cc = maps[maps.length-head-1];

					// @TODO
					// We may need change child name not to be number
					// array[head]
					str += '<div class="section-head"><p class="section-img-wrap"><a target="_blank" href="#" ref="'+childBigPath+'baby_big_'+cc+'.jpg" title="点击查看大图"><img src="'+childPath+'baby_'+cc+'.png" /></a></p></div>';
					str += '<div class="section-con">';

					$.each(items, function(i, num){

						if(i == 0 || i == len/2 ){
							str += '<ul class="clearfix section-list section-list'+step+'">';
						}

						str += '<li><p class="section-img-wrap"><img src="'+paPath+'parent_'+(num+1)+'.jpg" data-topic="'+that.n+'" data-ans="'+num+'" /><span>'+names[num]+'</span></p></li>';

						if(i == len/2 -1 || i == len-1){
							str += '</ul>';
						}

					});				

					str += '</div>';
					str += '<span class="section-num">'+that.n+'.</span>';

					ret.push(str);

					that.n++;
					
					});

					this.sectionInners.each(function(i, el){
						el.innerHTML = ret[i];		
					});

					//console.log(ret);
				},

				_makeArr : function(n){
					var arr = [];

					for(var i = 0; i < n; i++){
						arr.push(i);
					}

					return arr;
				},

				_makeRandomArr : function(arr, k){
					var i = 0, ret = [], j;
				 	for(; i < k; i++){
						j = Math.floor(Math.random()*arr.length);				 
						ret.push(arr[j]);
						arr.splice(j, 1);
					}				 

					return ret;
				},

				_makeMatchEmployee : function(child, j){
					var i = 4,
						num = i + j * 2,
						arr;

					/**********************************************/
					//---------------------------------------------
					// this.employee.splice(this.employee.indexOf(child), 1);

					arr = this._makeRandomArr(this.employee, num - 1);

					//console.log(arr);

					arr.splice(Math.floor(Math.random()*arr.length), 0, child);

					//console.log(arr);

					return arr;
			 	},

				_validate : function(){
					var f = true;

				 	$.each(this._result, function(i, item){
						if('undefined' === typeof item){
							f = false;	
							return false;
						}			 
					});

					if(/*this._result.length < (this.step + 1) * checks || */this._result.length < 16 || !f){
						alert('还有宝宝没有找到爸妈哦，赶快回去检查一下~!');
						return false;
					}			

					return true;
				},

				_getScore : function(){
					var sum = 0;

					$.each(this._result, function(i, item){
						var arr = item.split('-'),
							f = arr[0] === arr[1],
							m = Math.floor(i/4) * 25 + 25;		

						sum += f ? m : 0;
					});			

					return sum/10;
				},

				_preloadImg : function(arr){
					var d = location.href.lastIndexOf('/'),
						url = location.href.substring(0, d+1);

					$.each(arr, function(i, ret){
						$.each(ret, function(j, ts){
							$.each(ts, function(k, src){
								var img = new Image();		
								img.src = url + src + '.jpg';	
							});
						});		
					});			  
				},

				_scrollTop : function(){
					$('body,html').animate({scrollTop : '0px'}, 200);
					maskObj.show().hide();
				},

				_toggleRes : function(f){
					var that = this;

				 	if(f){
						maskObj.show();
					}else{
						maskObj.hide();
					}

					this.resultEl[f ? 'show' : 'hide']();
		   		},



				/**
				  *@For prev need cache some html
				  */
				_getCacheHtml : function(){
					var ret = [];

					this.sectionInners.each(function(i, inner){
						ret.push(inner.innerHTML);		
					});			

					return ret;
				},

				_rendCache : function(n){
					var that = this;
					$.each(this._cache[n], function(i, tmpl){
						that.sectionInners[i].innerHTML = tmpl;		
					});			 
				},
				
				/**
				  *@Show is beginning
				  */
				_startShow : function(){
					var anis = ['animate1', 'animate2'],
						that = this, imgs, len, arr, index;

					// remove no need section
					this.sections.each(function(i, section){
							if(i > 0) $(section).remove();		
					});

					imgs = this.sections.eq(0).find('img');
					pEls = this.sections.eq(0).find('.section-img-wrap');
					len = imgs.length;

					arr = this._makeRandomArr(this._makeArr(len), len);
					index = arr.indexOf(len-1);

					this.$('.active').removeClass('active');

					pEls.each(function(i, img){
						that._prefixedEve(img, 'add', function(){
							this.style.visibility = 'hidden';
							if(i == index){
								that._clearDoc();
								// Stage start
								stage1.init().addStage(stage2);
							}
						});
					});

					pEls.each(function(i, img){
						var $t = $(img);		

						setTimeout(function(){
							$t.addClass(anis[Math.floor(Math.random()*anis.length)]);
						}, 300 * arr[i]);
					});

					this._removeSomething();

			 	},



				_prefixedEve : function(el,ac,callback){
					var pfx = ['webkit','moz','MS','o',''];

					$.each(pfx,function(i,item){
						var type = item ? 'AnimationEnd' : 'animationend';
						el[ac+'EventListener'](item + type, callback, false);
					});
				},

				_removeSomething : function(){
					this.$('.section-num').remove();				   
					this.$('h3').text('');
					this.$('.section-outer').css('background','none');
					this.$('.wrapper-inner').css('background', 'none');
					this.$('.section-1').css('background', 'none');
				},

				_clearDoc : function(){
					this.$('.wrapper-inner').remove();
					maskObj.destroy();
					this.resultEl.remove();
				}

			}, base);
			
 		})().init();
	</script>
</body>
</html>
